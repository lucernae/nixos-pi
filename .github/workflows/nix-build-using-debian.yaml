# Just a sample workflow if using debian packages for binfmt
name: Nix Build On Demand
on:
  workflow_dispatch:
jobs:
  use-qemu-debian:
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v2.3.4
    - uses: cachix/install-nix-action@v12
      with:
        nix_path: nixpkgs=channel:nixos-20.09
        extra_nix_config: |
          extra-platforms = aarch64-linux
    - run: cat /etc/nix/nix.conf
    - uses: myci-actions/add-deb-repo@4
      with:
        repo: deb http://http.us.debian.org/debian sid main non-free contrib
        repo-name: debian-sid
        keys: 04EE7237B7D453EC
    - run: |
        sudo apt -y install qemu-user-static
    - name: Test aarch64-linux
      run: |
        cat /proc/sys/fs/binfmt_misc/qemu-aarch64
        /usr/bin/qemu-aarch64-static --version
    - run: |
        nix-build '<nixpkgs/nixos>'  \
          -A config.system.build.sdImage \
          -I nixos-config=./configuration.default.sdImage.nix \
          --argstr system aarch64-linux \
          --option sandbox false
    - uses: actions/upload-artifact@v2
      with:
        name: sd-image.img
        path: ./result/sd-image/*.img*
